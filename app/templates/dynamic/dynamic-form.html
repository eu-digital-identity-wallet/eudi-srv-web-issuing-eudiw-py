<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="Title" content="PID Form" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Keywords" content="EUDI Wallet, PID, Enrolment, Form" />
    <meta name="Description" content="PID Form for EUDI Wallet" />
    <meta name="robots" content="noindex, nofollow" />
    <meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}"
        type="image/vnd.microsoft.icon" />
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.gif') }}" type="image/gif" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}" />
    <meta name="referrer" content="no-referrer">

    <link href="{{ url_for('static', filename='css/tailwind.css') }}" rel="stylesheet">
    <title>Form for your EUDI Wallet</title>

</head>

{# =================================================================================== #}
{# RECURSIVE MACRO TO RENDER FORM ATTRIBUTES #}
{# =================================================================================== #}
{% macro render_attribute(name, attr, is_optional=false, name_prefix='') %}
<div class="dynamic-attribute-row" data-attr-name="{{ name }}">
    {% set current_name = name_prefix + ('[{}]'.format(name) if name_prefix else name) %}


    {# Dropdown Select Menu #}
    {% if attr.options is defined and attr.options %}
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ name | replace('_', ' ') | title }}</label>
        <select name="{{ current_name }}"
            class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500">
            {% for option in attr.options %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>
    </div>

    {# Simple Input Types (string, date, number) #}
    {% elif attr.type in ['string', 'full-date', 'uint'] or name == 'user_pseudonym' %}
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ name | replace('_', ' ') | title }}</label>
        <input type="{{ 'date' if attr.type == 'full-date' else 'number' if attr.type == 'uint' else 'text' }}"
            class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500"
            name="{{ current_name }}" value="{{ attr.filled_value if attr.filled_value is not none else '' }}" {% if
            attr.filled_value or name=='user_pseudonym' %}readonly{% endif %} {% if attr.get('mandatory') %}required{%
            endif %} {% if attr.type=='uint' %}min="0" {% endif %}>
    </div>

    {# Boolean (Toggle Switch) #}
    {% elif attr.type == 'bool' %}
    <div class="mb-6 flex items-center justify-between">
        <label class="font-pf text-lg font-bold text-gray-800">{{ name | replace('_', ' ') | title }}</label>
        <input type="hidden" name="{{ current_name }}" value="false">
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" value="true" class="sr-only peer toggle-input">
            <div class="w-11 h-6 bg-gray-200 rounded-full peer-checked:bg-indigo-600"></div>
            <div
                class="absolute top-0.5 left-[2px] w-5 h-5 bg-white rounded-full transition-transform peer-checked:translate-x-full">
            </div>
        </label>
    </div>

    {# List Type (Recursive & Conditional Logic) #}
    {% elif attr.type == 'list' %}
    <div class="p-4 border border-gray-200 rounded-md space-y-4 mb-4 list-container" data-list-name="{{ name }}" {% if
        attr.at_least_one_of %}data-at-least-one-of='{{ attr.at_least_one_of | tojson | safe }}' {% endif %}>
        <h3 class="text-lg font-semibold text-gray-800">{{ name | replace('_', ' ') | title }}</h3>
        <div class="hidden text-sm text-red-600 p-3 bg-red-50 rounded-md at-least-one-of-error">
            Please fill in at least one of the fields in this section.
        </div>
        <div class="list-items-wrapper space-y-4">

            {# Special handling for Seafarer 'capacities' (mdoc only). #}
            {% if name == 'capacities' %}
            <div class="list-item p-4 border rounded-md bg-gray-50 shadow-sm relative">
                {{ render_attribute('capacity_code', attr.attributes.capacity_code, is_optional,
                name_prefix=current_name + '[0]') }}
                {{ render_attribute('codes', attr.attributes.codes, is_optional, name_prefix=current_name + '[0]') }}
            </div>

            {# Logic for all other list types #}
            {% else %}
            <div class="list-item border-l-4 border-gray-300 pl-4">

                {% if name == 'places_of_work' %}
                {# Prepare a unified 'options' list from either dict (mdoc) or list (sd-jwt) structure #}
                {% if attr.attributes is mapping %}
                {% set options = attr.attributes.items() %}
                {% else %}
                {% set options = [] %}
                {% for item in attr.attributes %}{% for key, value in item.items() %}{% set _ = options.append((key,
                value)) %}{% endfor %}{% endfor %}
                {% endif %}

                <div class="flex flex-wrap gap-2 toggle-group mb-4">
                    {% for option_name, option_attr in options %}
                    <label class="toggle-option cursor-pointer">
                        <input type="radio" name="{{ current_name }}_option" value="{{option_name}}"
                            class="sr-only peer" data-option-name="{{option_name}}" {% if loop.first %}checked{% endif
                            %}>
                        <div
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-gray-50">
                            {{ option_name | replace('_', ' ') | title }}
                        </div>
                    </label>
                    {% endfor %}
                </div>
                {% for option_name, option_attr in options %}
                <div class="sub-container {% if not loop.first %}hidden{% endif %}" data-option-name="{{option_name}}">
                    {{ render_attribute(option_name, option_attr, is_optional, name_prefix=current_name + '[0]') }}
                </div>
                {% endfor %}
                {% else %}
                {# Fallback for other non-choice lists. This handles both structures. #}
                {% if attr.attributes is mapping %}
                {% for sub_name, sub_attr in attr.attributes.items() %}
                {{ render_attribute(sub_name, sub_attr, is_optional, name_prefix=current_name + '[0]') }}
                {% endfor %}
                {% elif attr.attributes is sequence %}
                {% for item in attr.attributes %}
                {% for sub_name, sub_attr in item.items() %}
                {{ render_attribute(sub_name, sub_attr, is_optional, name_prefix=current_name + '[0]') }}
                {% endfor %}
                {% endfor %}
                {% endif %}
                {% endif %}
            </div>
            {% endif %}
        </div>

        {# Add Item Button #}
        {% if attr.get('cardinality', {}).get('max') != 1 %}
        <button type="button" class="add-item text-sm font-semibold text-indigo-600 hover:text-indigo-800"
            data-parent-name="{{ name }}" data-name-prefix="{{ current_name }}"
            data-attributes='{{ attr.attributes | tojson | safe }}'>
            + Add {{ name | replace('_', ' ') | title }}
        </button>
        {% endif %}
    </div>

    {# Image Upload #}
    {% elif attr.type == 'jpeg' %}
    {% if name == 'signature_usual_mark' or name == 'signature_usual_mark_issuing_officer' %}
    <div class="mb-4">
        <label class="block text-lg font-semibold text-gray-800">{{ name | replace('_', ' ') | title }}</label>
        <p class="text-sm text-gray-600">Please select one option or upload a file.</p>
        <div class="mt-2 space-y-4">
            <div class="flex items-center gap-4">
                <label>
                    <input type="radio" name="{{ name }}" value="Sig1" class="sr-only peer/sig1" {% if not is_optional
                        %}checked{% endif %}>
                    <img src="{{ url_for('static', filename='signature1.jpg') }}"
                        class="w-24 h-24 rounded-lg border-2 border-transparent peer-checked/sig1:border-indigo-600 cursor-pointer object-cover opacity-50 peer-checked/sig1:opacity-100">
                </label>
            </div>
            <div>
                <label for="fileInput-{{name}}" class="cursor-pointer">
                    <input type="radio" name="{{ name }}" value="SigUpload" id="OptionSigUpload-{{name}}"
                        class="sr-only peer/sigupload">
                    <div
                        class="mt-2 p-4 border-2 border-dashed border-gray-300 rounded-lg text-center peer-checked/sigupload:border-indigo-600">
                        <input type="file" name="{{ name }}" id="fileInput-{{name}}" class="hidden file-input"
                            accept="image/jpeg" capture>
                        <span>Upload a signature file</span>
                        <p class="text-xs text-gray-500">Type: image/jpeg, Size(pixels): 360x100</p>
                    </div>
                </label>
                <div id="preview-{{name}}" class="mt-2"></div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="mb-4">
        <label class="block text-lg font-semibold text-gray-800">{{ name | replace('_', ' ') | title }}</label>
        <p class="text-sm text-gray-600">Please select one option or upload a file.</p>
        <div class="mt-2 space-y-4">
            <div class="flex items-center gap-4">
                <label>
                    <input type="radio" name="{{ name }}" value="Port1" class="sr-only peer/port1" {% if not is_optional
                        %}checked{% endif %}>
                    <img src="{{ url_for('static', filename='image.jpeg') }}"
                        class="w-24 h-24 rounded-lg border-2 border-transparent peer-checked/port1:border-indigo-600 cursor-pointer object-cover opacity-50 peer-checked/port1:opacity-100">
                </label>
                <label>
                    <input type="radio" name="{{ name }}" value="Port2" class="sr-only peer/port2">
                    <img src="{{ url_for('static', filename='image2.jpeg') }}"
                        class="w-24 h-24 rounded-lg border-2 border-transparent peer-checked/port2:border-indigo-600 cursor-pointer object-cover opacity-50 peer-checked/port2:opacity-100">
                </label>
            </div>
            <div>
                <label for="fileInput-{{name}}" class="cursor-pointer">
                    <input type="radio" name="{{ name }}" value="PortUpload" id="OptionPortUpload-{{name}}"
                        class="sr-only peer/portupload">
                    <div
                        class="mt-2 p-4 border-2 border-dashed border-gray-300 rounded-lg text-center peer-checked/portupload:border-indigo-600">
                        <input type="file" name="{{ name }}" id="fileInput-{{name}}" class="hidden file-input"
                            accept="image/jpeg" capture>
                        <span>Upload a file</span>
                        <p class="text-xs text-gray-500">Type: image/jpeg, Size(pixels): 360x433</p>
                    </div>
                </label>
                <div id="preview-{{name}}" class="mt-2"></div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endmacro %}


<body class="bg-gray-50 font-sans">
    <div role="main" class="mx-auto w-full max-w-screen-md p-6 flex flex-col min-h-screen">
        <div id="content" class="w-full flex flex-col bg-white p-8 rounded-xl shadow-lg"
            style="min-height: calc(100vh - 25vh);">
            <div class="space-y-2 mb-6">
                <p class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Test Issuer</p>
                <h1 class="font-pf text-4xl text-gray-800">EUDI Wallet Credential</h1>
                <p class="font-pf text-sm text-gray-700 leading-snug">Issue attributes for your <strong>EUDI
                        Wallet</strong> demo application.</p>
                <p class="text-sm italic text-gray-500">For testing purposes only.</p>
            </div>

            <form id="selectCountryForm" method="post" class="flex flex-col h-full" action="{{redirect_url}}"
                onsubmit="return submitValidation()" enctype="multipart/form-data">
                <div class="mt-10">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-6">Mandatory Information</h2>
                    {% for name, attr in mandatory_attributes.items() %}
                    {{ render_attribute(name, attr, is_optional=false) }}
                    {% endfor %}
                </div>

                <div id="visible-optional-attributes" class="mt-4"></div>

                <div id="add-attributes-button-container" class="my-6">
                    <button type="button" id="add-optional-btn"
                        class="w-full py-3 px-4 border border-gray-400 rounded-lg text-gray-600 font-semibold hover:bg-gray-100 transition-colors">
                        Add Optional Attributes
                    </button>
                </div>

                <div class="mt-auto py-10">
                    <div class="flex flex-col gap-1 items-center">
                        <button type="submit" name="proceed"
                            class="w-full bg-blue-900 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-800 transition-colors duration-200">
                            Confirm
                        </button>
                        <button type="button" name="Cancelled"
                            class="w-full border-gray-400 text-gray-500 font-semibold py-2 rounded-lg"
                            onclick="window.history.back();">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="hidden-attributes-storage" class="hidden">
        {% for name, attr in optional_attributes.items() %}
        {{ render_attribute(name, attr, is_optional=true) }}
        {% endfor %}
    </div>

    <div id="attributes-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-pf font-bold text-gray-800">Additional Attributes</h2><button
                    id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto space-y-4" id="modal-checkbox-list"></div>
            <div class="p-6 border-t bg-gray-50 rounded-b-lg">
                <div class="flex flex-col gap-2"><button id="modal-add-btn"
                        class="w-full bg-blue-900 text-white font-semibold py-3 rounded-lg">Add
                        Attributes</button><button id="modal-cancel-btn"
                        class="w-full text-gray-600 font-semibold py-2">Cancel</button></div>
            </div>
        </div>
    </div>

    <script>
        // Helper function to generate HTML for a new list item recursively.
        // It clones the first item from a hidden template, updates indices, and returns it.
        function cloneAndPrepareListItem(templateNode, newIndex, namePrefix) {
            const clone = templateNode.cloneNode(true);
            clone.querySelectorAll('input, select').forEach(input => {
                const oldName = input.getAttribute('name');
                if (oldName) {
                    // This regex replaces the first number in brackets e.g., name[0] -> name[1]
                    const newName = oldName.replace(/\[\d+\]/, `[${newIndex}]`);
                    input.setAttribute('name', newName);
                }
                // Reset values for the new item
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            return clone;
        }


        document.addEventListener('DOMContentLoaded', function () {
            // =======================================================
            // Main delegated event listener for all dynamic actions
            // =======================================================
            document.addEventListener('click', function (event) {

                // --- Handle Adding a new item to a list ---
                if (event.target.classList.contains('add-item')) {
                    const button = event.target;
                    const listContainer = button.closest('.list-container');
                    const wrapper = listContainer.querySelector('.list-items-wrapper');
                    const newIndex = wrapper.querySelectorAll(':scope > .list-item').length;

                    const templateItem = wrapper.querySelector('.list-item');
                    if (!templateItem) return;

                    const newItem = cloneAndPrepareListItem(templateItem, newIndex, button.dataset.namePrefix);

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    if (listContainer.dataset.listName === 'capacities') {
                        removeBtn.className = 'remove-list-item text-xs text-red-500 hover:text-red-700 font-semibold absolute top-2 right-2';
                        removeBtn.innerHTML = '&times; Remove Capacity';
                    } else {
                        removeBtn.className = 'remove-list-item text-xs text-red-500 hover:text-red-700 mt-2 font-semibold';
                        removeBtn.textContent = 'Remove';
                    }

                    newItem.appendChild(removeBtn);

                    wrapper.appendChild(newItem);
                }

                // --- Handle Removing an item from a list ---
                if (event.target.classList.contains('remove-list-item')) {
                    event.target.closest('.list-item').remove();
                }

                // --- Handle toggling choices like 'place_of_work' ---
                const toggleOption = event.target.closest('.toggle-option input[type="radio"]');
                if (toggleOption) {
                    const container = toggleOption.closest('.list-item');
                    const optionName = toggleOption.dataset.optionName;

                    container.querySelectorAll('.sub-container').forEach(sc => {
                        const isSelected = sc.dataset.optionName === optionName;
                        // Toggle visibility
                        sc.classList.toggle('hidden', !isSelected);
                        // Enable/disable inputs to ensure only selected data is submitted
                        sc.querySelectorAll('input, select, button').forEach(el => el.disabled = !isSelected);
                    });
                }

                const toggleInput = event.target.closest('.toggle-input');
                if (toggleInput) {
                    // This finds the hidden input that came just before the label for the toggle.
                    const hiddenInput = toggleInput.closest('label').previousElementSibling;
                    if (hiddenInput && hiddenInput.type === 'hidden') {
                        hiddenInput.value = toggleInput.checked ? 'true' : 'false';
                    }
                }
            });

            // Initialize choice-based sections on page load
            document.querySelectorAll('.toggle-group').forEach(group => {
                const checkedRadio = group.querySelector('input[type="radio"]:checked');
                if (checkedRadio) {
                    checkedRadio.dispatchEvent(new Event('click', { bubbles: true }));
                }
            });

            // =======================================================
            // Optional Attributes Modal Logic
            // =======================================================
            const modal = document.getElementById('attributes-modal');
            const openModalBtn = document.getElementById('add-optional-btn');
            const closeModalBtn = document.getElementById('modal-close-btn');
            const cancelModalBtn = document.getElementById('modal-cancel-btn');
            const addAttributesBtn = document.getElementById('modal-add-btn');
            const checkboxListContainer = document.getElementById('modal-checkbox-list');
            const hiddenStorage = document.getElementById('hidden-attributes-storage');
            const insertionPoint = document.getElementById('visible-optional-attributes');

            if (openModalBtn) {
                openModalBtn.addEventListener('click', function () {
                    checkboxListContainer.innerHTML = '';
                    hiddenStorage.querySelectorAll('.dynamic-attribute-row').forEach(block => {
                        const name = block.dataset.attrName;
                        if (!name) return;
                        const labelText = name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        const label = document.createElement('label');
                        label.className = 'flex items-center cursor-pointer p-2 rounded-md hover:bg-gray-100';
                        label.innerHTML = `<input type="checkbox" class="h-5 w-5 text-indigo-600 border-gray-400 rounded" value="${name}"><span class="ml-3 text-lg text-gray-800">${labelText}</span>`;
                        checkboxListContainer.appendChild(label);
                    });
                    modal.classList.remove('hidden');
                });
            }

            const closeModal = () => modal.classList.add('hidden');
            if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if (cancelModalBtn) cancelModalBtn.addEventListener('click', closeModal);
            if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

            if (addAttributesBtn) {
                addAttributesBtn.addEventListener('click', function () {
                    checkboxListContainer.querySelectorAll('input:checked').forEach(checkbox => {
                        const name = checkbox.value;
                        const blockToMove = hiddenStorage.querySelector(`[data-attr-name="${name}"]`);
                        if (blockToMove) {
                            const removeBtn = document.createElement('button');
                            removeBtn.type = 'button';
                            removeBtn.className = 'remove-optional-btn text-xs text-red-500 hover:text-red-700 mt-2 font-semibold';
                            removeBtn.textContent = 'Remove Attribute';
                            blockToMove.appendChild(removeBtn);
                            insertionPoint.appendChild(blockToMove);
                        }
                    });
                    closeModal();
                });
            }

            // --- Handle removing an optional attribute block ---
            document.addEventListener('click', function (event) {
                if (event.target.classList.contains('remove-optional-btn')) {
                    const row = event.target.closest('.dynamic-attribute-row');
                    if (row) {
                        row.querySelectorAll('input, select').forEach(input => {
                            if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                            else input.value = '';
                        });
                        hiddenStorage.appendChild(row);
                        event.target.remove();
                    }
                }
            });

            // =======================================================
            // Image Upload and Preview Logic
            // =======================================================
            document.body.addEventListener('change', function (event) {
                if (event.target.classList.contains('file-input')) {
                    const fileInput = event.target;
                    const file = fileInput.files[0];
                    const container = fileInput.closest('.dynamic-attribute-row');
                    const uploadRadio = container.querySelector('input[type="radio"][value="Port3"]');
                    const previewContainer = container.querySelector('[id^="preview-"]');

                    if (file && uploadRadio) {
                        uploadRadio.checked = true;
                        if (previewContainer) {
                            previewContainer.innerHTML = '';
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.className = 'w-24 h-auto rounded-lg mt-2 object-cover';
                                previewContainer.appendChild(img);
                            }
                            reader.readAsDataURL(file);
                        }
                    } else if (previewContainer) {
                        previewContainer.innerHTML = '';
                    }
                }
            });
        });


        // =======================================================
        // Form Submission Validation
        // =======================================================
        function submitValidation() {
            //at least one of validation
            document.querySelectorAll('.at-least-one-of-error').forEach(el => el.classList.add('hidden'));

            const containersToValidate = document.querySelectorAll('[data-at-least-one-of]');
            for (const container of containersToValidate) {
                const fields = JSON.parse(container.dataset.atLeastOneOf);

                // Use Array.some() to check if at least one field has a value
                const isAnyFieldFilled = fields.some(fieldName => {
                    const input = container.querySelector(`[name$="[${fieldName}]"]`);
                    return input && input.value.trim() !== '';
                });

                if (!isAnyFieldFilled) {
                    const errorElement = container.querySelector('.at-least-one-of-error');
                    if (errorElement) {
                        errorElement.classList.remove('hidden');
                    }
                    // Scroll the error into view for better user experience
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return false; // Prevent form submission
                }
            }

            const fileInputs = document.querySelectorAll('.file-input');
            for (const fileInput of fileInputs) {
                const radio = fileInput.closest('.dynamic-attribute-row').querySelector('input[type="radio"][value="Port3"]');
                if (radio && radio.checked) {
                    if (!fileInput.files[0]) {
                        alert('Please select a file to upload or choose another portrait option.');
                        return false;
                    }
                }
            }
            return true;
        }

        // Make functions globally accessible for inline event handlers
        window.submitValidation = submitValidation;
    </script>
</body>

</html>
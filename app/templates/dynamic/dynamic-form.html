<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="Title" content="PID Form" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Keywords" content="EUDI Wallet, PID, Enrolment, Form" />
    <meta name="Description" content="PID Form for EUDI Wallet" />
    <meta name="robots" content="noindex, nofollow" />
    <meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}"
        type="image/vnd.microsoft.icon" />
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.gif') }}" type="image/gif" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}" />
    <meta name="referrer" content="no-referrer">

    <link href="{{ url_for('static', filename='css/tailwind.css') }}" rel="stylesheet">
    <title>Form for your EUDI Wallet</title>

    <style>
        .list-item {
            list-style-type: none;
        }
    </style>
</head>

{% macro render_attribute(name, attr, is_optional=false) %}
<div class="dynamic-attribute-row" data-attr-name="{{ name }}">
    {% if attr.type == 'string' or attr.type == 'full-date' or attr.type == 'uint' or name == 'user_pseudonym' %}
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ name | replace('_', ' ') | title }}</label>
        <input type="{{ 'date' if attr.type == 'full-date' else 'number' if attr.type == 'uint' else 'text' }}"
            class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500"
            name="{{ name }}" value="{{ attr.filled_value if attr.filled_value is not none else '' }}" {% if
            attr.filled_value or name=='user_pseudonym' %}readonly{% endif %} {% if not is_optional %}required{% endif
            %} {% if attr.type=='uint' %}min="0" {% endif %}>
    </div>

    {% elif attr.type == 'list' %}
    <div class="p-4 border border-gray-200 rounded-md space-y-4 mb-4 list-container">
        <h3 class="text-lg font-semibold text-gray-800">{{ name | replace('_', ' ') | title }}</h3>

        {% if attr.attributes | length > 1 and attr.attributes[0].get('not_used_if') %}
        <div class="flex flex-wrap gap-2 toggle-group">
            {% for option in attr.attributes %}
            {% if option.get('not_used_if') %}
            <label class="toggle-option cursor-pointer">
                <input type="radio" name="{{ name }}_option" class="sr-only peer"
                    data-target-container="{{ name }}-{{ option.attribute }}-container">
                <div
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-gray-50">
                    {{ option.attribute | replace('_', ' ') | title }}
                </div>
            </label>
            {% endif %}
            {% endfor %}
        </div>

        {% for option in attr.attributes %}
        <div id="{{ name }}-{{ option.attribute }}-container" class="sub-container hidden space-y-4">
            {% if option.get('issuer_conditions', {}).get('cardinality', {}).get('max') != 1 %}
            <button type="button" class="add-item text-sm font-semibold text-indigo-600 hover:text-indigo-800"
                data-parent-name="{{ name }}" data-option-name="{{ option.attribute }}"
                data-attributes='{{ option | tojson | safe }}'>
                + Add {{ option.attribute | replace('_', ' ') }}
            </button>
            {% endif %}

            {# This wrapper is now correctly rendered EMPTY. The JS will add items to it. #}
            <div class="list-items-wrapper space-y-3">
            </div>

        </div>
        {% endfor %}

        {% else %}
        {% set option = attr.attributes[0] %}
        {% if attr.get('cardinality', {}).get('max') != 1 %}
        <button type="button" class="add-item text-sm font-semibold text-indigo-600 hover:text-indigo-800"
            data-parent-name="{{ name }}" data-attributes='{{ option | tojson | safe }}'>
            + Add {{ name | replace('_', ' ') }}
        </button>
        {% endif %}
        <div class="list-items-wrapper space-y-3">
            <div class="list-item space-y-3 p-3 bg-gray-50 rounded-md border">
                {% for sub_name, sub_attr in option.items() %}
                {% if sub_attr is mapping and sub_attr.get('value_type') %}
                <div class="space-y-1">
                    <label class="block text-xs font-medium text-gray-600">{{ sub_name | replace('_', ' ') | title
                        }}</label>
                    <input type="{{ 'date' if sub_attr.value_type == 'full-date' else 'text' }}"
                        class="w-full p-2 border border-gray-300 rounded-md" name="{{ name }}[0][{{ sub_name }}]" {% if
                        sub_attr.get('mandatory') and not is_optional %}required{% endif %}>
                </div>
                {% endif %}
                {% endfor %}
                {% if is_optional %}
                <button type="button"
                    class="remove-item-list text-xs text-red-600 hover:text-red-800 pt-2">Remove</button>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    {% elif attr.type == 'bool' %}
    <div class="mb-6 flex items-center justify-between">
        <label class="font-pf text-lg font-bold text-gray-800">{{ name | replace('_', ' ') | title }}</label>
        <input type="hidden" id="{{ name }}_hidden" name="{{ name }}" value="false">
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="{{ name }}" value="true" class="sr-only peer toggle-input" {% if not is_optional
                %}required{% endif %}>
            <div class="w-11 h-6 bg-gray-200 rounded-full peer-checked:bg-indigo-600"></div>
            <div
                class="absolute top-0.5 left-[2px] w-5 h-5 bg-white rounded-full transition-transform peer-checked:translate-x-full">
            </div>
        </label>
    </div>

    {% elif attr.type == 'jpeg' %}
    <div class="mb-4">
        <label class="block text-lg font-semibold text-gray-800">Portrait</label>
        <p class="text-sm text-gray-600">Please select one option or upload a file.</p>
        <div class="mt-2 space-y-4">
            <div class="flex items-center gap-4">
                <label>
                    <input type="radio" name="{{ name }}" value="Port1" class="sr-only peer/port1" {% if not is_optional
                        %}checked{% endif %}>
                    <img src="{{ url_for('static', filename='image.jpeg') }}"
                        class="w-24 h-24 rounded-lg border-2 border-transparent peer-checked/port1:border-indigo-600 cursor-pointer object-cover opacity-50 peer-checked/port1:opacity-100">
                </label>
                <label>
                    <input type="radio" name="{{ name }}" value="Port2" class="sr-only peer/port2">
                    <img src="{{ url_for('static', filename='image2.jpeg') }}"
                        class="w-24 h-24 rounded-lg border-2 border-transparent peer-checked/port2:border-indigo-600 cursor-pointer object-cover opacity-50 peer-checked/port2:opacity-100">
                </label>
            </div>
            <div>
                <label for="fileInputTrigger" class="cursor-pointer">
                    <input type="radio" name="{{ name }}" value="Port3" id="Option3" class="sr-only peer/port3">
                    <div
                        class="mt-2 p-4 border-2 border-dashed border-gray-300 rounded-lg text-center peer-checked/port3:border-indigo-600">
                        <input type="file" name="{{ name }}" id="fileInput" class="hidden" accept="image/jpeg" capture>
                        <span>Upload a file</span>
                        <p class="text-xs text-gray-500">Type: image/jpeg, Size(pixels): 360x433</p>
                    </div>
                </label>
                <div id="preview" class="mt-2"></div>
            </div>
        </div>
    </div>

    {% elif attr.type == 'driving_privileges' %}
    <div class="p-4 border border-gray-200 rounded-md space-y-4 mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Driving Privileges</h3>
        <div id="AddCategory">
            <div class="form-group removeclass1 space-y-2">
                <label>Category</label>
                <select name="Category1" class="w-full p-2 border border-gray-300 rounded-md">
                    <option>AM</option>
                    <option>A1</option>
                    <option>A2</option>
                    <option>A</option>
                    <option>B1</option>
                    <option>B</option>
                    <option>C1</option>
                    <option>C</option>
                    <option>D1</option>
                    <option>D</option>
                    <option>BE</option>
                    <option>C1E</option>
                    <option>CE</option>
                    <option>D1E</option>
                    <option>DE</option>
                </select>
                <div>Issue Date: <input type="date" class="w-full p-2 border border-gray-300 rounded-md"
                        name="IssueDate1" {% if not is_optional %}required{% endif %}></div>
                <div>Expiry Date: <input type="date" class="w-full p-2 border border-gray-300 rounded-md"
                        name="ExpiryDate1" {% if not is_optional %}required{% endif %}></div>
            </div>
        </div>
        <button type="button" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800"
            onclick="addDrivingCategory();">+ Add Category</button>
        <div id="hidden_elems">
            {% for elem, value in hidden_elems %}
            <input type="hidden" value="{{ value }}" name="{{ elem }}">
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endmacro %}


<body class="bg-gray-50 font-sans">
    <div role="main" class="mx-auto w-full max-w-screen-md p-6 flex flex-col min-h-screen">
        <div id="content" class="w-full flex flex-col bg-white p-8 rounded-xl shadow-lg"
            style="min-height: calc(100vh - 25vh);">
            <div class="space-y-2 mb-6">
                <p class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Test Issuer</p>
                <h1 class="font-pf text-4xl text-gray-800">EUDI Wallet Credential</h1>
                <p class="font-pf text-sm text-gray-700 leading-snug">Issue attributes for your <strong>EUDI
                        Wallet</strong> demo application.</p>
                <p class="text-sm italic text-gray-500">For testing purposes only.</p>
            </div>

            <form id="selectCountryForm" method="post" class="flex flex-col h-full" action="{{redirect_url}}"
                onsubmit="return submitValidation()" enctype="multipart/form-data">
                <p class="font-pf font-bold">Define the attribute(s) status:</p>

                <div class="mt-10">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-6">Mandatory Information</h2>
                    {% for name, attr in mandatory_attributes.items() %}
                    {{ render_attribute(name, attr, is_optional=false) }}
                    {% endfor %}
                </div>

                <div id="visible-optional-attributes" class="mt-4">
                    {# Optional attributes will be moved here by JS when added #}
                </div>

                <div id="add-attributes-button-container" class="my-6">
                    <button type="button" id="add-optional-btn"
                        class="w-full py-3 px-4 border border-gray-400 rounded-lg text-gray-600 font-semibold hover:bg-gray-100 transition-colors">
                        Add Optional Attributes
                    </button>
                </div>

                <div class="mt-auto py-10">
                    <div class="flex flex-col gap-1 items-center">
                        <button type="submit" onclick="addNumberCategories()" name="proceed"
                            class="w-full bg-blue-900 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-800 transition-colors duration-200">
                            Confirm
                        </button>
                        <button type="button" name="Cancelled"
                            class="w-full border-gray-400 text-gray-500 font-semibold py-2 rounded-lg"
                            onclick="window.history.back();">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="hidden-attributes-storage" class="hidden">
        {% for name, attr in optional_attributes.items() %}
        {{ render_attribute(name, attr, is_optional=true) }}
        {% endfor %}
    </div>

    <div id="attributes-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-pf font-bold text-gray-800">Additional Attributes</h2>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl">Ã—</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto space-y-4" id="modal-checkbox-list"></div>
            <div class="p-6 border-t bg-gray-50 rounded-b-lg">
                <div class="flex flex-col gap-2">
                    <button id="modal-add-btn" class="w-full bg-blue-900 text-white font-semibold py-3 rounded-lg">Add
                        Attributes</button>
                    <button id="modal-cancel-btn" class="w-full text-gray-600 font-semibold py-2">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('attributes-modal');
            const openModalBtn = document.getElementById('add-optional-btn');
            const closeModalBtn = document.getElementById('modal-close-btn');
            const cancelModalBtn = document.getElementById('modal-cancel-btn');
            const addAttributesBtn = document.getElementById('modal-add-btn');
            const checkboxListContainer = document.getElementById('modal-checkbox-list');
            const hiddenStorage = document.getElementById('hidden-attributes-storage');
            const insertionPoint = document.getElementById('visible-optional-attributes');

            openModalBtn.addEventListener('click', function () {
                checkboxListContainer.innerHTML = '';
                hiddenStorage.querySelectorAll('.dynamic-attribute-row').forEach(block => {
                    const name = block.dataset.attrName;
                    if (name) {
                        const labelText = name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        const label = document.createElement('label');
                        label.className = 'flex items-center cursor-pointer p-2 rounded-md hover:bg-gray-100';
                        label.innerHTML = `<input type="checkbox" class="h-5 w-5 text-indigo-600 border-gray-400 rounded" value="${name}"><span class="ml-3 text-lg text-gray-800">${labelText}</span>`;
                        checkboxListContainer.appendChild(label);
                    }
                });
                modal.classList.remove('hidden');
            });

            function closeModal() { modal.classList.add('hidden'); }
            closeModalBtn.addEventListener('click', closeModal);
            cancelModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

            addAttributesBtn.addEventListener('click', function () {
                checkboxListContainer.querySelectorAll('input:checked').forEach(checkbox => {
                    const name = checkbox.value;
                    const blockToMove = hiddenStorage.querySelector(`[data-attr-name="${name}"]`);
                    if (blockToMove) {
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-btn text-xs text-red-500 hover:text-red-700 mt-2';
                        removeBtn.textContent = 'Remove';
                        blockToMove.appendChild(removeBtn);
                        insertionPoint.appendChild(blockToMove);
                    }
                });
                closeModal();
            });

            document.addEventListener("click", function (event) {
                if (event.target.classList.contains('remove-btn')) {
                    const row = event.target.closest('.dynamic-attribute-row');
                    if (row) {
                        row.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
                        row.querySelectorAll('input:not([type="checkbox"])').forEach(i => i.value = '');
                        row.querySelectorAll('input[type="hidden"]').forEach(h => h.value = 'false');
                        hiddenStorage.appendChild(row);
                        event.target.remove();
                    }
                }

                if (event.target.classList.contains("add-item")) {
                    const button = event.target;
                    const attributes = JSON.parse(button.dataset.attributes);
                    const parentName = button.dataset.parentName;
                    const optionName = button.dataset.optionName;
                    let wrapper = button.closest('.sub-container, .list-container').querySelector('.list-items-wrapper');
                    if (!wrapper) return;
                    const currentIndex = wrapper.querySelectorAll('.list-item').length;

                    if (currentIndex > 0) {
                        const separator = document.createElement('hr');
                        separator.className = 'my-4 border-t border-gray-200';
                        wrapper.appendChild(separator);
                    }

                    const newItem = document.createElement("div");
                    newItem.className = "list-item space-y-3 p-3 bg-gray-50 rounded-md border";
                    let innerHTML = '';
                    let fieldsToRender = attributes;

                    if (attributes.issuer_conditions) {
                        const nestedKey = Object.keys(attributes.issuer_conditions).find(k => k.endsWith('_attributes'));
                        if (nestedKey) fieldsToRender = attributes.issuer_conditions[nestedKey];
                    } else if (attributes.attributes && attributes.attributes[0]) {
                        fieldsToRender = attributes.attributes[0];
                    }

                    for (const [key, val] of Object.entries(fieldsToRender)) {
                        if (typeof val !== 'object' || !val.value_type) continue;
                        const inputType = val.value_type === "full-date" ? "date" : "text";
                        const inputName = optionName ? `${parentName}[${optionName}][${currentIndex}][${key}]` : `${parentName}[${currentIndex}][${key}]`;
                        const labelText = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        innerHTML += `<div class="space-y-1"><label class="block text-xs font-medium text-gray-600">${labelText}</label><input type="${inputType}" class="w-full p-2 border border-gray-300 rounded-md" name="${inputName}" ${val.mandatory ? 'required' : ''}></div>`;
                    }
                    innerHTML += `<button type="button" class="remove-item-list text-xs text-red-600 hover:text-red-800 pt-2">Remove</button>`;
                    newItem.innerHTML = innerHTML;
                    wrapper.appendChild(newItem);
                }

                if (event.target.classList.contains("remove-item-list")) {
                    const listItem = event.target.closest(".list-item");
                    if (listItem) {
                        const previousSibling = listItem.previousElementSibling;
                        if (previousSibling && previousSibling.tagName === 'HR') {
                            previousSibling.remove();
                        }
                        listItem.remove();
                    }
                }

                if (event.target.closest('.toggle-option')) {
                    const button = event.target.closest('.toggle-option');
                    const listContainer = button.closest('.list-container');
                    if (!listContainer) return;
                    const targetContainerId = button.querySelector('input').dataset.targetContainer;
                    listContainer.querySelectorAll('.sub-container').forEach(sc => sc.classList.add('hidden'));
                    const targetContainer = document.getElementById(targetContainerId);
                    if (targetContainer) targetContainer.classList.remove('hidden');
                }

                if (event.target.closest('label[for="fileInputTrigger"]')) {
                    document.getElementById('fileInput').click();
                }

                const toggleInput = event.target.closest('.toggle-input');
                if (toggleInput) {
                    const hiddenInput = toggleInput.closest('.dynamic-attribute-row').querySelector('input[type="hidden"]');
                    if (hiddenInput) hiddenInput.value = toggleInput.checked ? 'true' : 'false';
                }
            });

            document.querySelectorAll(".toggle-group").forEach(group => {
                const firstToggle = group.querySelector(".toggle-option input");
                if (firstToggle) {
                    firstToggle.checked = true;
                    firstToggle.closest('label').dispatchEvent(new Event('click', { bubbles: true }));
                }
            });
        });

        let categoryCount = 1;
        function addDrivingCategory() {
            categoryCount++;
            const container = document.getElementById('AddCategory');
            const newCategoryDiv = document.createElement("div");
            newCategoryDiv.className = `form-group removeclass${categoryCount} space-y-2 mt-4`;
            newCategoryDiv.innerHTML = `
                <label>Category</label>
                <select name="Category${categoryCount}" class="w-full p-2 border border-gray-300 rounded-md">
                    <option>AM</option><option>A1</option><option>A2</option><option>A</option><option>B1</option><option>B</option>
                    <option>C1</option><option>C</option><option>D1</option><option>D</option><option>BE</option><option>C1E</option>
                    <option>CE</option><option>D1E</option><option>DE</option>
                </select>
                <div>Issue Date: <input type="date" class="w-full p-2 border border-gray-300 rounded-md" name="IssueDate${categoryCount}" required></div>
                <div>Expiry Date: <input type="date" class="w-full p-2 border border-gray-300 rounded-md" name="ExpiryDate${categoryCount}" required></div>
                <button type="button" class="text-xs text-red-600 hover:text-red-800" onclick="this.parentElement.remove();">Remove Category</button>
            `;
            container.appendChild(newCategoryDiv);
        }

        function addNumberCategories() {
            const container = document.getElementById('hidden_elems');
            if (!container) return;
            const existingCount = container.querySelector('input[name="NumberCategories"]');
            if (existingCount) { existingCount.parentElement.remove(); }
            const div = document.createElement("div");
            div.innerHTML = `<input type="hidden" value="${categoryCount}" name="NumberCategories">`;
            container.appendChild(div);
        }

        function submitValidation() {
            const optionalAttributes = JSON.parse('{{ optional_attributes | tojson | safe }}');
            if (!optionalAttributes || !optionalAttributes.at_least_one_of) { return validateImage(); }
            const at_least_one_of = optionalAttributes["at_least_one_of"];
            if (at_least_one_of && at_least_one_of.length > 0) {
                const isAnyFieldFilled = at_least_one_of.some(field => {
                    let input = document.querySelector(`input[name="${field}"]`);
                    return input && input.value.trim() !== "";
                });
                if (!isAnyFieldFilled) {
                    let missingFieldsMessage = at_least_one_of.map(field => field.replace(/_/g, " ").replace(/\b\w/g, char => char.toUpperCase())).join(", ");
                    alert("At least one of the following fields must be filled: " + missingFieldsMessage);
                    return false;
                }
            }
            return validateImage();
        }

        function validateImage() {
            const radioUpload = document.getElementById('Option3');
            if (!radioUpload || !radioUpload.checked) return true;
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file to upload or choose another portrait option.');
                return false;
            }
            if (file.type !== 'image/jpeg') {
                alert('Uploaded file must be a JPEG image.');
                return false;
            }
            return true;
        }
    </script>
</body>

</html>
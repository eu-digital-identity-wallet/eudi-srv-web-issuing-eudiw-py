<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no" />
    <meta name="Title" content="Age Verification Form" />
    <meta name="Keywords" content="Age Verification, Enrolment, Form" />
    <meta name="Description" content="Age Verification Form for Age Verification Wallet" />
    <meta name="robots" content="noindex, nofollow" />
    <meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}"
        type="image/vnd.microsoft.icon" />
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.gif') }}" type="image/gif" />

    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}" />
    <link href="{{ url_for('static', filename='css/tailwind.css') }}" rel="stylesheet">
    <script type="text/javascript" id="jqueryId"
        src="{{ url_for('static', filename='scripts/jquery/jquery-3.6.3.min.js') }}" charset="UTF-8"></script>

    <script type="text/javascript" src="{{ url_for('static', filename='scripts/promiz/promiz-1.0.6.js') }}"
        charset="UTF-8"></script>

    <script type="text/javascript" src="{{ url_for('static', filename='scripts/html5shiv/html5shiv-3.7.3.js') }}"
        charset="UTF-8"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='scripts/respond/respond-1.4.2.js') }}"
        charset="UTF-8"></script>
    <meta name="referrer" content="no-referrer">

    <title>Confirm data from your EUDI Wallet</title>
</head>

{# ===================================================================== #}
{# recursive macro for nested attributes #}
{# ===================================================================== #}
{% macro render_attribute_display(name, value) %}
{# It's a list of items (like capacities, codes, driving_privileges) #}
{% if value is sequence and value is not string %}
<div class="attribute-block">
    <label class="font-pf block font-bold text-custom-gray">{{ name | replace('_', ' ') | title }}</label>
    <div class="mt-2 pl-4 border-l-2 border-gray-400 space-y-3">
        {% for item in value %}
        {# For each item in the list, create a slightly indented block #}
        <div class="bg-white/60 p-3 rounded-md">
            {# Check if the item is a dictionary before trying to loop through its items #}
            {% if item is mapping %}
            {% for sub_name, sub_value in item.items() %}
            {# Recursively call the macro to display the item's contents #}
            {{ render_attribute_display(sub_name, sub_value) }}
            {% endfor %}
            {# If the item is not a dictionary (e.g., just a string), display it directly #}
            {% else %}
            <p class="font-pf text-base text-custom-gray">{{ item }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{# It's an image #}
{% elif name in ["portrait", "issuing_authority_logo", "signature_usual_mark_issuing_officer", "image"] %}
<div class="attribute-block">
    <label class="block text-base font-bold text-custom-gray">{{ name | title }}</label>
    <img class="mt-1 rounded-lg shadow-md w-32 h-32 object-cover" src="data:image/jpeg;base64,{{ value }}">
</div>
{# It's a simple value (string, number, etc.) #}
{% else %}
<div class="attribute-block">
    <label class="font-pf block font-bold text-custom-gray">{{ name | replace('_', ' ') | title }}</label>
    <p class="font-pf text-base text-custom-gray mt-1">{{ value }}</p>
</div>
{% endif %}
{% endmacro %}


<body class="bg-white">
    <div role="main" class="mx-auto w-full max-w-screen-md p-6 flex flex-col min-h-screen">

        <!-- Header Section  -->
        <div class="space-y-2 mb-8">
            <p class="text-sm font-semibold uppercase tracking-wider text-gray-500">Test Issuer</p>
            <h1 class="font-pf text-4xl font-bold text-gray-800">Review & Send</h1>
            <p class="font-pf text-base text-gray-600">
                Please review the selected attributes before sending to the EudiWallet demo app.
            </p>
        </div>

        <!-- The Form -->
        <form id="authForm" method="post" action="{{redirect_url}}" class="flex-grow flex flex-col">

            <div class="flex-grow">
                <!-- The Inset Data Card -->
                <div class="bg-gray-200 rounded-xl p-6">
                    <div class="space-y-5">

                        {# ===================================================================== #}
                        {# It now uses the macro to correctly render all data structures. #}
                        {# ===================================================================== #}
                        {% for category_name, attributes in presentation_data.items() %}
                        {# Display a title for each credential type #}
                        <h2 class="text-2xl font-pf font-bold text-gray-900 pb-2 mb-3 border-b border-gray-400/50">
                            {{ category_name }}
                        </h2>
                        {# Loop through attributes and let the macro handle the display logic #}
                        {% for name, value in attributes.items() %}
                        {{ render_attribute_display(name, value) }}
                        {% endfor %}
                        {% endfor %}

                    </div>
                </div>
            </div>

            <!-- Hidden user_id input-->
            <input type="hidden" value="{{ user_id }}" name="user_id">

            <!-- Action Buttons -->
            <div class="mt-auto pt-8">
                <div class="flex flex-col gap-2 items-center">
                    <button type="submit" name="proceed"
                        class="w-full bg-blue-900 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-800 transition-colors">
                        Authorize
                    </button>
                    <a href="/auth_choice"
                        class="w-full text-center text-gray-600 font-semibold py-2 rounded-lg hover:bg-gray-100">
                        Cancel
                    </a>
                </div>
            </div>

        </form>
    </div>
</body>

</html>